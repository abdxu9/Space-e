<<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map with Route</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 500px; width: 100%; }
        #error-message { color: red; font-weight: bold; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="error-message"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Initialize the Leaflet map
    const map = L.map('map').setView([51.505, -0.09], 13); // Default view

    // Add a tile layer (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    async function getLocationAndCallRoutingAPI() {
        try {
            // Get user's current location
            const position = await getCurrentLocation();
            const { latitude, longitude } = position.coords;

            console.log("User's Current Location:", latitude, longitude);
            map.setView([latitude, longitude], 13);

            // Destination coordinates (replace with your desired destination)
            const destLat = 45.77116;
            const destLon = 3.08743;

            const apiKey = 'cf3d916c-ca66-43f1-9889-d5efbc56d457'; // Replace with your actual GraphHopper API key

            const resp = await fetch(
                `https://graphhopper.com/api/1/route?key=${apiKey}`,
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        profile: 'car',
                        points: [
                            [longitude, latitude],
                            [destLon, destLat]
                        ],
                        point_hints: ['Current Location', 'Destination'],
                        snap_preventions: ['motorway', 'ferry', 'tunnel'],
                        details: ['road_class', 'surface'],
                        points_encoded: false  // Set to false to receive non-encoded polylines
                    })
                }
            );

            if (!resp.ok) {
                throw new Error(`HTTP error! status: ${resp.status}`);
            }

            const data = await resp.json();
            console.log('GraphHopper Route Data:', data);

            // Check if paths exist
            if (data.paths && data.paths.length > 0) {
                // The points are now in the format [[lon1, lat1], [lon2, lat2], ...]
                // We need to reverse them for Leaflet which expects [lat, lon]
                const routeCoordinates = data.paths[0].points.coordinates.map(point => [point[1], point[0]]);
                
                // Plot the route on the map
                const routeLine = L.polyline(routeCoordinates, { color: 'blue' }).addTo(map);
                map.fitBounds(routeLine.getBounds());
            } else {
                throw new Error('No valid route found');
            }

        } catch (error) {
            console.error('Error occurred:', error);
            document.getElementById('error-message').textContent = `Error: ${error.message}`;
        }
    }

    function getCurrentLocation() {
        return new Promise((resolve, reject) => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(resolve, reject);
            } else {
                reject(new Error("Geolocation is not supported by this browser."));
            }
        });
    }

    // Call the function to get location and display the route on the map
    getLocationAndCallRoutingAPI();
</script>

</body>
</html>